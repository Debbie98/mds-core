#!/bin/bash

set -e
set -u
set -o pipefail

BASE_DIR=$(dirname $0)/..
: ${NODE_ENV:=""}
: ${REGISTRY:=""}
if [[ -n "$REGISTRY" ]]; then  # if non-empty
  REGISTRY="$(echo $REGISTRY | sed 's#/$##')/"  # ensure '/' suffix
fi

buildImage() {
  local image=$1
  local tag=$(echo $image | cut -f2 -d":")
  if [[ ! -d "$BASE_DIR/dist" ]]; then mkdir $BASE_DIR/dist; fi
  if [[ "$tag" != "latest" ]]; then
    image=${image}$(getBranchSuffix)$(getCommitHash)
  fi
  docker build -t ${REGISTRY}${image} .
  echo ${REGISTRY}${image} >> $BASE_DIR/dist/images.txt
}

pushImages() {

  function ecr_check_create_repo {
    # ECR repos are individual resources - create if not present
    local repo=$1
    if [[ -z "$(aws ecr describe-repositories \
      --query "repositories[?repositoryName=='$repo'].repositoryName" \
      --output text)" ]]
    then
      info "No repo found for $repo - creating..."
      aws ecr create-repository --repository-name $repo \
        --image-scanning-configuration scanOnPush=true
    fi
  }

  # assert correct registry
  local imagecount=$(wc -l dist/images.txt | cut -f1 -d' ')
  local regcount=$(grep ^$REGISTRY dist/images.txt \
    | wc -l | cut -f1 -d' ')

  if (( $imagecount == $regcount )); then  # parens for arithmatic comparison
    aws ecr get-login-password --region us-west-2 \
      | docker login --password-stdin --username AWS $REGISTRY
    for image in $(cat $BASE_DIR/dist/images.txt); do
      repository=$(echo $image | sed -e 's#.*/##' -e 's/:.*//')  # strip registry prefix, tag suffix
      ecr_check_create_repo $repository
      docker push $image
    done
  else
    echo "ERROR: missing registry prefix in dist/images.txt?" 1>&2
    exit 1
  fi
}

getBranchSuffix() {
  git rev-parse --abbrev-ref HEAD | sed -E -e 's/[^-a-zA-Z0-9]/-/g' -e 's/^/-/'
}

getCommitHash() {
  git rev-parse --short HEAD | sed -E -e 's/[^-a-zA-Z0-9]/-/g' -e 's/^/-/'
}

images() {
  for d in $BASE_DIR/container-images/*/package.json; do
    basename $(dirname $d)
  done
}

templateValues() {
  suffix="$(getBranchSuffix)$(getCommitHash)"
  for image in $(images); do
    version=$(jq -r '.version' < $BASE_DIR/container-images/$image/package.json)
    varname="$(echo $image | sed -e 's/^lacuna-//' -e 's/^mds-//' -e 's/-/_/g' | tr a-z A-Z)_VERSION"
    export $varname=${version}${suffix}
  done
  mkdir -p dist
  envsubst < $BASE_DIR/values.yaml.tpl > $BASE_DIR/dist/values-mds.yaml
  echo "Wrote dist/values-mds.yaml"
}

CALL=$1; shift
$CALL $@
